<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Detalle del Producto | ETHERE4L</title>
    <link rel="stylesheet" href="assets/css/style.css">
    <link rel="stylesheet" href="assets/css/responsive.css"> 
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    
    <style>
        /* --- ESTILOS ESPEC√çFICOS DEL PRODUCTO --- */
        .size-selector-container { margin: 20px 0; }
        .size-options { display: flex; gap: 10px; margin: 10px 0; }
        .size-option input { display: none; }
        .size-option span {
            padding: 10px 20px; border: 1px solid #ddd; cursor: pointer; transition: 0.2s;
            display: inline-block; min-width: 45px; text-align: center; color: #333; font-weight: bold;
        }
        .size-option input:checked + span { background: #000; color: #fff; border-color: #000; }
        
        /* Bot√≥n de la calculadora */
        .btn-calc-size {
            background: none; border: none; color: #555; text-decoration: underline;
            cursor: pointer; font-size: 0.9rem; margin-top: 5px; display: inline-block;
        }
        .btn-calc-size:hover { color: #000; }

        /* Grid de Relacionados */
        .related-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-top: 20px;
        }
        @media(min-width: 768px) { .related-grid { grid-template-columns: repeat(4, 1fr); } }

        .related-card img { width: 100%; height: auto; object-fit: cover; }
        .related-card h4 { font-size: 0.9rem; margin: 5px 0; color: #000; }
        .related-card p { font-size: 0.8rem; color: #666; }
        .related-card { text-decoration: none; color: inherit; }

        /* Animaci√≥n Bot√≥n Compra */
        @keyframes clickPulse { 0% { transform: scale(1); } 50% { transform: scale(0.95); } 100% { transform: scale(1); } }
        .btn-added { background-color: #2ecc71 !important; pointer-events: none; }

        /* --- NUEVO: ESTILOS SOURCING PRIVADO --- */
        .sourcing-box {
            background-color: #f9f9f9;
            border-left: 3px solid #000;
            padding: 15px;
            margin: 20px 0;
            display: flex;
            align-items: flex-start;
            gap: 12px;
        }
        .sourcing-box i { font-size: 1.2rem; color: #333; margin-top: 3px; }
        .sourcing-box h5 { margin: 0 0 5px 0; font-size: 0.85rem; text-transform: uppercase; letter-spacing: 0.5px; }
        .sourcing-box p { margin: 0; font-size: 0.8rem; color: #555; line-height: 1.4; }

        /* --- ESTILOS DEL MODAL CALCULADORA --- */
        .modal-overlay {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.8); z-index: 9999; justify-content: center; align-items: center;
        }
        .modal-content {
            background: #fff; padding: 25px; max-width: 400px; width: 90%; position: relative;
            text-align: center; border-radius: 4px;
        }
        .close-modal {
            position: absolute; top: 10px; right: 15px; font-size: 24px; cursor: pointer; color: #000;
        }
        .modal-input {
            width: 100%; padding: 10px; margin: 8px 0; border: 1px solid #ddd;
            font-family: inherit; box-sizing: border-box;
        }
        .btn-calculate {
            width: 100%; padding: 12px; background: #000; color: #fff; border: none;
            cursor: pointer; margin-top: 10px; font-weight: bold; text-transform: uppercase;
        }
        .result-box {
            margin-top: 15px; font-weight: bold; font-size: 1.1rem; color: #000;
            min-height: 20px;
        }

        /* =========================================
           ETHERE4L IMAGE CLS LOCK ‚Äì PRO MODE
           Core Web Vitals Optimization
        ========================================= */

        /* Forzamos ratio uniforme fashion 4:5 */
        .main-image-container,
        .thumbnails-container img,
        .related-card > div {
            aspect-ratio: 4 / 5;
            overflow: hidden;
        }

        /* Todas las im√°genes llenan el contenedor */
        .main-image-container img,
        .thumbnails-container img,
        .related-card img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: block;
        }

        /* Thumbnails espec√≠fico */
        .thumbnails-container {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        .thumbnails-container img {
            cursor: pointer;
            opacity: 0.7;
            transition: opacity 0.2s;
            flex: 1;
            min-width: 0;
        }

        .thumbnails-container img:hover {
            opacity: 1;
        }
    </style>
</head>
<body class="product-page-body">

<nav class="navbar">
    <div class="logo-nav">
        <a href="index.html">
            <span class="logo-text-gothic">ETHERE4L</span>
        </a>
    </div>

    <i class="fa-solid fa-bars" id="mobile-menu" style="display:none;"></i>

    <ul class="nav-list" id="nav-list">
        <li><a href="index.html">Inicio</a></li>
        <li class="dropdown-trigger">
            <a href="#">Marcas <i class="fa-solid fa-chevron-down" style="font-size: 0.7em;"></i></a>
            <ul class="dropdown-menu" id="lista-marcas">
            </ul>
        </li>
        <li class="cart-icon-nav">
            <a href="pedido.html">
                <i class="fa-solid fa-shopping-bag"></i>
            </a>
        </li>
    </ul>
</nav>

<div class="container-detalle">
    <button class="btn-back" onclick="window.history.back()" style="border:none; background:none; font-size:1.2rem; cursor:pointer; margin-bottom:10px;">
        <i class="fa-solid fa-arrow-left"></i>
    </button>

    <div class="product-wrapper">
        <div class="product-gallery">
            <div class="main-image-container">
                <img 
                id="main-img" 
                src="" 
                alt="Producto"
                loading="eager"
                fetchpriority="high"
                >

            </div>
            <div class="thumbnails-container" id="thumbnails"></div>
        </div>

        <div class="product-info">
            <h2 id="marca-producto" class="brand-title" style="color:#666; font-size:0.9rem; text-transform:uppercase; letter-spacing:1px;">...</h2>
            <h1 id="nombre-producto" class="product-title" style="font-size:1.8rem; margin:5px 0;">...</h1>
            <p id="precio-producto" class="price" style="font-size:1.4rem; font-weight:bold;">...</p>
            
            <p id="desc-producto" class="description" style="margin:20px 0; color:#555; line-height:1.6;"></p>

            <div class="sourcing-box">
                <i class="fa-solid fa-box-open"></i>
                <div>
                    <h5>Sourcing Privado</h5>
                    <p>Esta referencia se gestiona bajo pedido individual y se env√≠a directamente a tu domicilio con seguimiento internacional incluido.</p>
                </div>
            </div>

            <div class="size-selector-container">
                <p style="font-size: 0.9rem; font-weight: bold;">Selecciona tu talla:</p>
                <div class="size-options">
                    <label class="size-option"><input type="radio" name="size" value="S"><span>S</span></label>
                    <label class="size-option"><input type="radio" name="size" value="M"><span>M</span></label>
                    <label class="size-option"><input type="radio" name="size" value="L"><span>L</span></label>
                    <label class="size-option"><input type="radio" name="size" value="XL"><span>XL</span></label>
                </div>
                <button type="button" class="btn-calc-size" onclick="abrirModalSize()">
                    üìè ¬øCu√°l es mi talla? (Calculadora)
                </button>
            </div>
            
            <button id="btn-add-cart" class="btn-buy" style="width:100%; padding:18px; background:#000; color:#fff; border:none; margin-top:20px; font-weight:bold; cursor:pointer;">
                A√ëADIR A LA BOLSA
            </button>
            
            <p style="font-size:0.75rem; text-align:center; color:#888; margin-top:10px;">
                Gastos de env√≠o calculados al finalizar la compra.
            </p>
        </div>
    </div>

    <div class="related-section" style="margin-top:60px; padding-top:40px; border-top:1px solid #eee;">
        <h3 style="text-align:center; text-transform:uppercase; margin-bottom:20px;">Colecci√≥n Completa</h3>
        <div id="related-grid" class="related-grid"></div>
    </div>
</div>

<div id="modal-size" class="modal-overlay">
    <div class="modal-content">
        <span onclick="cerrarModalSize()" class="close-modal">&times;</span>
        <h3 style="margin-bottom:15px; text-transform:uppercase;">Size Calculator</h3>
        
        <label style="display:block; text-align:left; font-size:0.8rem; margin-bottom:2px;">Altura (cm)</label>
        <input type="number" id="calc-altura" class="modal-input" placeholder="Ej: 175">
        
        <label style="display:block; text-align:left; font-size:0.8rem; margin-bottom:2px;">Peso (kg)</label>
        <input type="number" id="calc-peso" class="modal-input" placeholder="Ej: 70">
        
        <label style="display:block; text-align:left; font-size:0.8rem; margin-bottom:2px;">Preferencia de Fit</label>
        <select id="calc-fit" class="modal-input">
            <option value="regular">Regular Fit (Normal)</option>
            <option value="slim">Slim Fit (Ajustado)</option>
            <option value="oversized">Oversized (Holgado)</option>
        </select>

        <button onclick="calcularTalla()" class="btn-calculate">Calcular Talla</button>
        <p id="resultado-talla" class="result-box"></p>
        <p style="font-size:0.7rem; color:#888; margin-top:10px;">Esta es una sugerencia basada en promedios.</p>
    </div>
</div>

<script src="assets/js/cart.js"></script> 
<script src="assets/js/main.js"></script> 
<script>
    let allProducts = [];
    let currentProduct = null;

    // --- L√ìGICA CALCULADORA DE TALLAS ---
    function abrirModalSize() {
        document.getElementById('modal-size').style.display = 'flex';
    }

    function cerrarModalSize() {
        document.getElementById('modal-size').style.display = 'none';
        document.getElementById('resultado-talla').innerText = '';
    }

    function calcularTalla() {
        const altura = parseFloat(document.getElementById('calc-altura').value);
        const peso = parseFloat(document.getElementById('calc-peso').value);
        const fit = document.getElementById('calc-fit').value;

        if(!altura || !peso) {
            document.getElementById('resultado-talla').innerText = "‚ö†Ô∏è Ingresa altura y peso.";
            return;
        }

        let score = 0;
        if (peso < 60) score = 1;      // S
        else if (peso < 75) score = 2; // M
        else if (peso < 85) score = 3; // L
        else score = 4;                // XL

        if (altura > 185 && score < 4) score += 1;

        if (fit === 'oversized' && score < 4) score += 1;
        if (fit === 'slim' && score > 1) score -= 1;

        const tallas = { 1: 'S', 2: 'M', 3: 'L', 4: 'XL' };
        const recomendacion = tallas[score] || 'XL';

        document.getElementById('resultado-talla').innerText = `Te sugerimos talla: ${recomendacion}`;
    }

    // --- FUNCIONES PRINCIPALES ---

    // 1. INICIALIZAR
    async function initPage() {
        const params = new URLSearchParams(window.location.search);
        const productId = params.get('id');

        try {
            const res = await fetch('data/productos.json'); 
            allProducts = await res.json();
            // Comparaci√≥n laxa (==) por si id viene como string o number
            currentProduct = allProducts.find(p => p.id == productId);

            if (currentProduct) {
                renderProduct(currentProduct);
                renderRelated(currentProduct.marca, currentProduct.id);
            } else {
                // Manejo b√°sico de error si no encuentra ID
                document.querySelector('.product-wrapper').innerHTML = '<p style="text-align:center; padding:50px;">Producto no encontrado.</p>';
            }
        } catch (error) {
            console.error("Error cargando productos:", error);
        }
    }

    // 2. RENDER PRODUCTO (‚úÖ OPTIMIZADO PARA CORE WEB VITALS)
    function renderProduct(p) {
        document.getElementById('marca-producto').innerText = p.marca;
        document.getElementById('nombre-producto').innerText = p.nombre;
        
        // Manejo visual de precio
        if (typeof p.precio === 'string' && p.precio.toLowerCase().includes('none')) {
             document.getElementById('precio-producto').innerText = "Consultar Precio";
        } else {
             // Aseguramos formato visual correcto
             const precioVisual = p.precio.toString().replace('$', ''); 
             document.getElementById('precio-producto').innerText = `$${precioVisual} MXN`;
        }
        
        document.getElementById('desc-producto').innerText = p.descripcion || "Edici√≥n limitada. Sourcing internacional bajo demanda.";
        
        // ‚úÖ OPTIMIZACI√ìN 1: Imagen principal con eager loading + async decoding
        const mainImg = document.getElementById('main-img');
        mainImg.src = p.fotos[0];
        mainImg.loading = "eager"; // Imagen principal carga inmediata (mejora LCP)
        mainImg.decoding = "async"; // Decodificaci√≥n as√≠ncrona

        const thumbContainer = document.getElementById('thumbnails');
        thumbContainer.innerHTML = '';
        if (p.fotos.length > 1) {
            p.fotos.forEach(foto => {
                const img = document.createElement('img');
                img.src = foto;
                // ‚úÖ OPTIMIZACI√ìN 2: Miniaturas con lazy loading
                img.loading = "lazy";
                img.decoding = "async";
                img.onclick = () => {
                    const targetImg = document.getElementById('main-img');
                    targetImg.src = foto;
                };
                thumbContainer.appendChild(img);
            });
        }
    }

    // 3. RENDER RELACIONADOS (‚úÖ OPTIMIZADO PARA CORE WEB VITALS)
    function renderRelated(marca, currentId) {
        const grid = document.getElementById('related-grid');
        const related = allProducts.filter(p => p.marca === marca && p.id != currentId); 

        if (related.length === 0) {
            grid.innerHTML = "<p>No hay m√°s productos en esta colecci√≥n.</p>";
            return;
        }

        grid.innerHTML = related.map(p => {
            const displayPrice = (typeof p.precio === 'string' && p.precio.toLowerCase().includes('none')) 
                ? "Ver detalle" 
                : `$${p.precio.toString().replace('$','')}`;

            // ‚úÖ OPTIMIZACI√ìN 3: Productos relacionados con lazy loading
            return `
                <a href="producto.html?id=${p.id}" class="related-card">
                    <div style="background:#f4f4f4; margin-bottom:10px;">
                        <img 
                            src="${p.fotos[0]}" 
                            alt="${p.nombre}"
                            loading="lazy"
                            decoding="async"
                        >
                    </div>
                    <h4>${p.nombre}</h4>
                    <p>${displayPrice}</p>
                </a>
            `;
        }).join('');
    }

    // 4. A√ëADIR AL CARRITO (CORE UPDATE)
    document.getElementById('btn-add-cart').addEventListener('click', function() {
        const sizeInput = document.querySelector('input[name="size"]:checked');
        
        // VALIDACI√ìN
        if (!sizeInput) {
            alert("‚ö†Ô∏è Por favor selecciona una talla antes de continuar.");
            document.querySelector('.size-options').style.border = "1px solid red";
            setTimeout(() => document.querySelector('.size-options').style.border = "none", 2000);
            return;
        }

        if(typeof addToCart === 'function') {
            // PREPARACI√ìN DE DATA PARA CHECKOUT INTELIGENTE
            // Usamos un fallback de peso (0.6kg) si el JSON no lo tiene, para no romper el c√°lculo de env√≠o.
            const productWeight = currentProduct.peso ? parseFloat(currentProduct.peso) : 0.6;
            
            addToCart({
                id: currentProduct.id,
                nombre: currentProduct.nombre,
                // Limpiamos el precio para guardar solo n√∫meros o string limpio en el cart
                precio: currentProduct.precio.toString().replace('$','').trim(), 
                talla: sizeInput.value,
                imagen: currentProduct.fotos[0],
                // Nuevos campos cr√≠ticos para el sistema de dropshipping
                peso: productWeight,
                sourcing: true,
                cantidad: 1 // Default inicial
            });

            // FEEDBACK VISUAL
            const btn = this;
            const originalText = btn.innerText;
            
            btn.style.animation = 'clickPulse 0.3s ease'; 
            btn.innerText = "A√ëADIDO ‚úì";
            btn.classList.add('btn-added'); 
            
            setTimeout(() => {
                btn.innerText = originalText;
                btn.classList.remove('btn-added'); 
                btn.style.animation = '';
            }, 1500);
        } else {
            console.error("Critical Error: addToCart function missing.");
        }
    });

    // Cerrar modal al hacer click fuera
    window.onclick = function(event) {
        const modal = document.getElementById('modal-size');
        if (event.target == modal) {
            cerrarModalSize();
        }
    }

    initPage();
</script>

</body>
</html>